# MvcCore Extension - Router - Localization

[![Latest Stable Version](https://img.shields.io/badge/Stable-v4.3.1-brightgreen.svg?style=plastic)](https://github.com/mvccore/ext-router-localization/releases)
[![License](https://img.shields.io/badge/Licence-BSD-brightgreen.svg?style=plastic)](https://mvccore.github.io/docs/mvccore/4.0.0/LICENCE.md)
![PHP Version](https://img.shields.io/badge/PHP->=5.3-brightgreen.svg?style=plastic)

MvcCore Router extension to have localized and non-localized URL addresses in your application, very configurable. URL addresses could contain localization by language code or by language and locale code together (`/en/custom/path` or `/en-US/custom/path` or `/any/non-localized/path`). Router works with any http method and with multi or single language route patterns and reverses.

## Outline  
1. [Installation](#user-content-1-installation)  
2. [Features](#user-content-2-features)  
	2.1. [Features - Routing](#user-content-21-features---routing)  
	2.2. [Features - Url Generating](#user-content-22-features---url-generating)  
3. [How It Works](#user-content-3-how-it-works)  
	3.1. [How It Works - Routing](#user-content-31-how-it-works---routing)  
	3.2. [How It Works - Url Completing](#user-content-32-how-it-works---url-completing)  
4. [Usage](#user-content-4-usage)  
	4.1. [Usage - `Bootstrap` Initialization](#user-content-41-usage---bootstrap-initialization)  
	4.2. [Usage - Default Localization](#user-content-42-usage---default-localization)  
	4.3. [Usage - Allowed Localizations](#user-content-43-usage---allowed-localizations)  
	4.4. [Usage - Routes Configuration](#user-content-44-usage---routes-configuration)  
	4.5. [Usage - Allow Non-Localized Routes](#user-content-45-usage---allow non-localized-routes)  
	4.6. [Usage - Detect Localization Only By Language](#user-content-46-usage---detect-localization-only-by-language)  
	4.7. [Usage - Localization Equivalents](#user-content-47-usage---localization-equivalents)  
	4.8. [Usage - Route Records By Language And Locale](#user-content-48-usage---route-records-by-language-and-locale)  
	4.9. [Usage - Redirect To Default And Back In First Request](#user-content-49-usage---redirect-to-default-and-back-in-first-request)  
	4.10. [Usage - Localized URL In Non-Localized Request](#user-content-410-usage---localized-url-in-non-localized-request)  
5. [Advanced Configuration](#user-content-5-advanced-configuration)  
	5.1. [Advanced Configuration - Session Expiration](#user-content-51-advanced-configuration---session-expiration)  
	5.2. [Advanced Configuration - Strict Session Mode](#user-content-52-advanced-configuration---strict-session-mode)  
	5.3. [Advanced Configuration - Routing `GET` Requests Only](#user-content-53-advanced-configuration---routing-get-requests-only)   

## 1. Installation
```shell
composer require mvccore/ext-router-localization
```

## 2. Features

### 2.1. Features - Routing
- Router routes requests in localization in URL address containing only international lowercase language code or containing both codes - international language code, dash and uppercase international locale code.
- Router accepts non-localized routes and localized routes with `pattern` and `defaults` (or with `match` and `reverse`) by language keys or by language and locale keys if necessary.
- Router acceps only allowed languages or languages and locale codes in rewrited URL addresses or in `localization` query string param, all other values are redirected to default localization.
- Router keeps only one URL address version for default localization home page (under slash address - `/` or `/index.php`). Requests to default localization home page are redirected to slash URL address automaticaly.
- Router recognizes user device localization settings by HTTP header `Accept-Language` in first request.
- Router stores recognized device localization in its own session namespace with configurable expiration (to not process localization recognition in every request again).
- Router redirects requests by configuration to different language (and locale) in first request localization recognition by HTTP header.
- Router redirects requests by configuration to different language (and locale) in strict session mode to localization from session.
- Router completes `$request->GetLang()` and `$request->GetLocale();` (or `$router->GetLocalization();`) values to use them anywhere in your app.
- Router replaces possibly founded localization prefix substring (containing lowercase international language code and optionally uppercase international locale code) in request path (`$request->GetPath();`) with an empty string. It keeps request path every time in the same form to process routing as usual.

[go to top](#user-content-outline)

### 2.2. Features - Url Generating

- Router completes every application URL (or every `GET` URL by configuration) generated by built-in `Url()` method with lowercase international language code only at the beginning or with both codes - international language code with dash and with uppercase international locale code at the beginning and those prefixed localizations are completed automaticly by currently requested localization or by localization given as second argument array with URL params for `Url()` method.
- Router could generate also localized url addresses under non-localized requests by setting up router by `$router->SetLocalization($lang [,$locale]);`.

[go to top](#user-content-outline)

## 3. How It Works

### 3.1. How It Works - Routing
- Router completes localization from these sources:
	- From requested URL (if there is no localization prefix in URL and home page is requested, it's completed to default loc.).
	- From session (if there is nothing, it stays on `NULL`).
	- From special `$_GET` param to switch localization in session strict mode (also could be `NULL`).
- Router process pre-route redirections by source data if necessary:
	- If there is allowed value in special `$_GET` switching param:
		  - New localization is stored in session and request is redirected to new localization by special switching param.
	- Else if there is no localization in session from any previous request:
		  - There is recognized nearest localization by sended `Accept-Language` HTTP header and stored in the session for next requests.
		- There is also completed flag if the detected version is the same as the requested version and flag if detected version is best match between allowed localizations in application and highly prioritized localization in HTTP header.
	- If strict session mode is configured to `FALSE` (by default):
		- If the request is first (nothing is in session from previous requests):
TODOOOOOO
			- If the detected localization match is not the best:
				- Redirect user to default language version:
				
			- Else route request with requested localization in a standard way later, do not process any redirections.
		- Else route request with requested localization in a standard way later, do not process any redirections.
	- If strict session mode is configured to `TRUE`:
		- If the requested localization is different from the session version:
			- Redirect user to session version.
		- Else route request with requestedlocalization in a standard way later, do not process any redirections.
- Router removes any founded localization URL prefix to process routing for any localizaton with the same request path.
- Then the router, routes request in a standard way.

[go to top](#user-content-outline)
	
### 3.2. How It Works - Url Completing
- The router generates URL addresses always with the same localization as requested localization version:
	- For addresses without any defined rewrite route, there is added into query string additional param about localization (`&localization=...`).
	- For addresses with defined rewrite route, there is prepended localization URL prefix by router configuration.
- If requested version is default localization, there is not necessary to put into URL addresses any additional data, so for default localization, there is always the same original URL string without any special params or prefixes.
- If you define into build-in `Url()` method into second argument array into params any different localization than requested localization is, there is added into result URL string query param or localization URL prefix by given localization param value.
- If there is configured session strict mode, special `$_GET` switching param is always added automatically.

[go to top](#user-content-outline)

## 4. Usage

## 4.1. Usage - `Bootstrap` Initialization
Add this to `Bootstrap.php` or to **very application beginning**, 
before application routing or any other extension configuration
using router for any purposes:
```php
$app = & \MvcCore\Application::GetInstance();
$app->SetRouterClass('\MvcCore\Ext\Routers\Localization');
...
// to get router instance for next configuration:
/** @var $router \MvcCore\Ext\Routers\Localization */
$router = & \MvcCore\Router::GetInstance();
```

[go to top](#user-content-outline)

## 4.2. Usage - Default Localization

Default localization configuration is always required.
```php
$router->SetDefaultLocalization('en-US');
```

[go to top](#user-content-outline)

## 4.3. Usage - Allowed Localizations

Default localization configured above `en-US` is allowed automaticly. 

Any other request (e.g. path like: `/something`) is not localized and it's redirected to default localization path  
`/en-US/something`, which could be usefull to prevent URL typo mistakes.

But also any other requested localization not allowed (e.g. path like: `/nl-NL/product-lijst`) is not used to localize request and request is redirected to default localization path `/en-US/nl-NL/product-lijst`, which could generate error 404 - not found.

```php
$router->SetAllowedLocalizations(/*'en-US', */'en-DE');
```

[go to top](#user-content-outline)

## 4.4. Usage - Routes Configuration

```php
$router->SetRoutes([
	// If you want to add non-localized route, 
	// you can use only definition like this:
	'Admin\Index:Index'		=> '/admin',
	// Localized route with automaticly completed `match` 
	// and `reverse` records from `pattern` record:
	'Front\Product:List'	=> [
		'pattern'				=> [
			'en'					=> "/products-list",
			'de'					=> "/produkte-liste",
		],
	],
	// 
	'Front\Product:Detail'	=> [
		'match'					=> [
			'en'					=> '#^/product/(?<id>\d+)#',
			'de'					=> '#^/produkt/(?<id>\d+)#'
		],
		'reverse'				=> [
			'en'					=> '/product/<id>',
			'de'					=> '/produkt/<id>'
		],
		'defaults'				=> [
			'en'					=> 'red',
			'de'					=> 'rot'
		]
	],
	'Front\Index:Index'		=> [
		'pattern'				=> '/<path>',
		// constraints are never localized
		'constraints'			=> [
			'path' 					=> '[-a-zA-Z0-9_/]*'
		]
	],
]);
```

[go to top](#user-content-outline)

## 5. Configuration

### Allowed languages
For every multilanguage application is necessary to allow more than default language:
```php
\MvcCore\Ext\Routers\Localization::GetInstance()->SetAllowedLangs('en', 'de');
```

### Default language
When request language is not possible to recognize by url address, no possible to recognize by http header `'Accept-Language'` and no language is in session from previous request, default language is used. Default language is `'en'` by default. To configure default language, use:
```php
\MvcCore\Ext\Routers\Localization::GetInstance()->SetDefaultLang('de');
```

### Prevent not localized requests
To prevent all requests for whole application, which have not any language in the beginning to redirect them into default language, you can use:
```php
\MvcCore\Ext\Routers\Localization::GetInstance()->SetAllowNonLocalizedRoutes(FALSE);
```
Non localized routes are allowed by default.


### Choose language in first request strictly by user agent
To choose language in first request by user agent http header `'Accept-Language'`, where is nothing in session yet, you can use:
```php
\MvcCore\Ext\Routers\Localization::GetInstance()->SetAllowNonLocalizedRoutes(TRUE);
```
This options is FALSE by default.

### 5.2. Configuration - Session Expiration
There is possible to change session expiration about detected media
site version value to not recognize media site version every request
where is no prefix in URL, because to process all regular expressions 
in `\Mobile_Detect` library could take some time. By **default** there is **1 hour**. 
You can change it by:
```php
$router->SetSessionExpirationSeconds(
    \MvcCore\Session::EXPIRATION_SECONDS_DAY
);
```

[go to top](#user-content-outline)

### 5.3. Configuration - Strict Session Mode
**In session strict mode, there is not possible to change media site version only by requesting different media site version prefix in URL.**
Stric session mode is router mode when media site version is managed by session value from the first request recognition. 
All requests to different media site version than the version in session are automatically redirected to media site version stored in the session.

Normally, there is possible to get different media site version only by 
requesting different media site version URL prefix. For example - to get 
a different version from `full` version, for example, to get `mobile` version, 
it's only necessary to request application with configured `mobile` prefix 
in URL like this: `/mobile/any/application/request/path`.

In session strict mode, there is possible to change media site version only by special `$_GET` parameter in your media version navigation. For example - 
to get a different version from `full` version, for example, `mobile` version, 
you need to add into query string parameters like this:
`/any/application/request/path?switch_media_version=mobile`
Then, there is changed media site version stored in the session and the user is redirected to the mobile application version with mobile URL prefixes everywhere.

To have this session strict mode, you only need to configure router by:
```php
$router->SetStricModeBySession(TRUE);
```

[go to top](#user-content-outline)

### 5.4. Configuration - Routing `GET` Requests Only
The router manages media site version only for `GET` requests. It means
redirections to the proper version in session strict mode or to redirect
in the first request to recognized media site version. `POST` requests
and other request methods to manage for media site version doesn't make sense. For those requests, you have still media site version record in session and you can use it any time. But to process all
request methods, you can configure the router to do so like this:
```php
$router->SetRouteGetRequestsOnly(FALSE);
```
